<script lang="ts">
    import { uid } from "uid"
    import { activePopup, activeShow, alertMessage, cachedShowsData, dictionary, fullColors, globalGroupViewEnabled, groups, selected, showsCache } from "../../../stores"
    import { createKeydownHandler } from "../../../utils/clickable"
    import { getAccess } from "../../../utils/profile"
    import { sortByName } from "../../helpers/array"
    import { ondrop } from "../../helpers/drop"
    import { history } from "../../helpers/history"
    import Icon from "../../helpers/Icon.svelte"
    import { _show } from "../../helpers/shows"
    import T from "../../helpers/T.svelte"
    import FloatingInputs from "../../input/FloatingInputs.svelte"
    import MaterialButton from "../../inputs/MaterialButton.svelte"
    import Center from "../../system/Center.svelte"
    import SelectElem from "../../system/SelectElem.svelte"
    import { getSlideGroups } from "./groups"

    $: showId = $activeShow?.id || ""
    $: showGroups = getSlideGroups(showId, $showsCache, $cachedShowsData)

    $: currentShow = $showsCache[showId]

    $: layoutSlides = currentShow?.layouts?.[_show().get("settings.activeLayout")]?.slides || []
    function countGroupsInLayout(slideId) {
        let count = layoutSlides.reduce((count, slide) => (slide.id === slideId ? count + 1 : count), 0)
        return count
    }

    $: globalGroups = Object.entries($groups).map(([id, group]) => {
        let name = group.name
        if (group.default) name = $dictionary.groups?.[group.name] || ""
        return { id, group: name, color: group.color || null, globalGroup: id, settings: {}, notes: "", items: [] }
    })

    $: sortedGroups = sortByName(globalGroups, "group")

    let profile = getAccess("shows")
    $: isLocked = currentShow?.locked || profile.global === "read" || profile[currentShow?.category || ""] === "read"

    $: displayGlobalGroups = $globalGroupViewEnabled
    $: if (showId) updateGroupView()
    function updateGroupView() {
        displayGlobalGroups = !showGroups.length ? true : $globalGroupViewEnabled
    }
</script>

<div class="groupsScroll">
    <div class="main" style="{showGroups.length ? '' : 'height: 100%;'}{displayGlobalGroups ? 'width: 50%;' : ''}">
        {#if displayGlobalGroups}
            <h4><T id="groups.current" /></h4>
        {/if}
        {#if showGroups.length}
            {#each showGroups as slide}
                {@const groupCount = countGroupsInLayout(slide.id)}
                <SelectElem id="group" data={{ id: slide.id }} draggable>
                    <!-- style="{$fullColors ? 'background-' : ''}color: {slide.color};{$fullColors && slide.color ? `color: ${getContrast(slide.color)};` : ''}" -->
                    <div
                        class="slide {isLocked ? '' : 'context #group'}"
                        role="button"
                        tabindex="0"
                        style="border-bottom: 2px solid {slide.color};{$fullColors ? '' : `color: ${slide.color};`}"
                        on:click={(e) => {
                            if (isLocked) {
                                alertMessage.set(currentShow?.locked ? "show.locked_info" : "profile.locked")
                                activePopup.set("alert")
                                return
                            }

                            if (!e.ctrlKey && !e.metaKey) {
                                selected.set({ id: "group", data: [{ id: slide.id }] })
                                ondrop(null, "slide")
                                selected.set({ id: null, data: [] })
                            }
                        }}
                        on:keydown={createKeydownHandler((e) => {
                            if (isLocked) {
                                alertMessage.set(currentShow?.locked ? "show.locked_info" : "profile.locked")
                                activePopup.set("alert")
                                return
                            }

                            if (!e.ctrlKey && !e.metaKey) {
                                selected.set({ id: "group", data: [{ id: slide.id }] })
                                ondrop(null, "slide")
                                selected.set({ id: null, data: [] })
                            }
                        })}
                    >
                        <p data-title={slide.group}>
                            {slide.group || "—"}
                            {#if groupCount > 1}<span class="shortcut" style="opacity: 0.5;font-style: initial;">{groupCount}</span>{/if}
                        </p>
                    </div>
                </SelectElem>
            {/each}
        {:else}
            <Center faded>
                <T id="empty.slides" />
            </Center>
        {/if}
    </div>

    {#if displayGlobalGroups}
        <div class="seperator" />

        <div class="main" style={displayGlobalGroups ? "width: 50%;" : ""}>
            <h4><T id="groups.global" /></h4>
            {#if sortedGroups.length}
                {#each sortedGroups as slide}
                    <SelectElem id="global_group" data={{ slide }} draggable>
                        <!-- style="{$fullColors ? 'background-' : ''}color: {slide.color};{$fullColors && slide.color ? `color: ${getContrast(slide.color)};` : ''}" -->
                        <div
                            class="slide context #global_group"
                            role="button"
                            tabindex="0"
                            style="border-bottom: 2px solid {slide.color};{$fullColors ? '' : `color: ${slide.color};`}"
                            on:click={(e) => {
                                if (isLocked) {
                                    alertMessage.set(currentShow?.locked ? "show.locked_info" : "profile.locked")
                                    activePopup.set("alert")
                                    return
                                }

                                if (!e.ctrlKey && !e.metaKey && $activeShow) {
                                    // , unique: true
                                    history({ id: "SLIDES", newData: { data: [{ ...slide, id: uid() }] } })
                                }
                            }}
                            on:keydown={createKeydownHandler((e) => {
                                if (isLocked) {
                                    alertMessage.set(currentShow?.locked ? "show.locked_info" : "profile.locked")
                                    activePopup.set("alert")
                                    return
                                }

                                if (!e.ctrlKey && !e.metaKey && $activeShow) {
                                    // , unique: true
                                    history({ id: "SLIDES", newData: { data: [{ ...slide, id: uid() }] } })
                                }
                            })}
                        >
                            <p data-title={slide.group}>
                                {slide.group || "—"}
                                {#if $groups[slide.id]?.shortcut}<span class="shortcut">{$groups[slide.id].shortcut}</span>{/if}
                            </p>
                        </div>
                    </SelectElem>
                {/each}
            {:else}
                <Center faded>
                    <T id="empty.slides" />
                </Center>
            {/if}
        </div>
    {/if}

    <FloatingInputs round>
        <MaterialButton title="groups.toggle_global_group" on:click={() => globalGroupViewEnabled.set(!$globalGroupViewEnabled)}>
            <Icon id="groups" white={!displayGlobalGroups} />
        </MaterialButton>
    </FloatingInputs>
</div>

<style>
    .groupsScroll {
        position: relative;

        display: flex;
        align-items: flex-start;

        height: 100%;
        padding: 10px;

        overflow-y: auto;
    }

    .main {
        display: flex;
        flex-direction: column;

        width: 100%;

        /* two columns */
        /* justify-content: space-between;
        flex-wrap: wrap;
        align-content: flex-start; */

        gap: 3px;
        flex: 1;
        overflow-x: clip;
    }

    /* two columns */
    /* .main :global(.selectElem) {
        width: 47%;
    } */

    .slide {
        /* padding: 5px; */
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8em;
        font-weight: 600;
        background-color: var(--primary-darker);
        border-radius: var(--border-radius);
        cursor: pointer;
        padding: 0 5px;
    }
    .slide:hover {
        filter: brightness(1.1);
    }

    .slide p {
        display: flex;
        align-items: center;
    }
    .shortcut {
        position: absolute;
        inset-inline-end: 5px;
        background-color: var(--primary-darker);

        color: rgb(255 255 255 / 0.5);
        opacity: 0.8;
        font-style: italic;
        font-size: 0.8em;
        padding-inline-start: 5px;
    }

    h4 {
        overflow: visible;
        text-align: center;
        color: var(--text);
    }

    .seperator {
        width: 1px;
        height: 100%;
        margin: 0 10px;
        background-color: var(--primary-lighter);
    }
</style>
